name: Daily Automated Testing & Reporting

on:
  schedule:
    # Runs at 06:00 UTC every day
    - cron: '0 6 * * *'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  test_and_report:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./flutter_app
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0' # Ensure this matches your project
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Unit & Widget Tests (Fast Feedback)
        run: flutter test

      - name: Run Integration Tests (Headless)
        # Running on Linux (headless) for speed. For Android UI, use reactivecircus/android-emulator-runner
        run: flutter test integration_test/app_test.dart -d flutter-tester

      - name: Send Daily Report Email
        if: always() # Send email even if tests fail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Hostel App Daily Report: ${{ job.status }}"
          body: |
            Daily Automated Quality Assurance Report
            ----------------------------------------
            Overall Status: ${{ job.status }}
            
            - Functional Tests: Completed
            - Performance Checks: Completed
            - Regression Checks: Completed
            
            View full logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_USER }}
          from: Automated QA Bot <${{ secrets.EMAIL_USER }}>
